<!doctype html><html lang=zh-CN><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><meta charset=UTF-8><meta name=generator content="Hugo 0.139.4"><meta name=theme-color content="#16171d"><meta name=color-scheme content="light dark"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no, date=no, address=no, email=no"><meta http-equiv=Cache-Control content="no-transform"><meta http-equiv=Cache-Control content="no-siteapp"><title>PhysX CCT设计与缺陷 | VisualGMQ的博客</title>
<link rel=stylesheet href=/css/meme.min.a553246e45381c74ed22bb9960198853498d9c268e287f215ecd9b947a82c5f5.css><script src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js defer></script><script src=/js/meme.min.02528176b28688e7b908e67b2eaf703af877d269f9158b19b29dd872ac4b8268.js></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Noto+Serif+SC:wght@400;500;700&amp;family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" media=print onload='this.media="all"'><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Noto+Serif+SC:wght@400;500;700&amp;family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap"></noscript><meta name=author content><meta name=description content="本文基于PhysX5.5.0源码分析（不过PhysX在这方面从4.0开始几乎没有什么改动）。讲述了PhysX CharacterController的设计实现，以及其中存在的问题。
注：PhysX的CCT实现非常简陋（如果不是工作原因不建议看源码，有这时间不如去看看UE或者Jolt这种物理引擎的实现），而且存在很多问题。我是因为工作原因才要学习，没办法。
"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=mask-icon href=/icons/safari-pinned-tab.svg color=#2a6df4><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-title content="VisualGMQ的博客"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=mobile-web-app-capable content="yes"><meta name=application-name content="VisualGMQ的博客"><meta name=msapplication-starturl content="../../"><meta name=msapplication-TileColor content="#fff"><meta name=msapplication-TileImage content="../../icons/mstile-150x150.png"><link rel=manifest href=/manifest.json><link rel=canonical href=https://visualgmq.github.io/posts/physx-cct%E8%AE%BE%E8%AE%A1%E4%B8%8E%E7%BC%BA%E9%99%B7/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","datePublished":"2025-08-02T17:26:12+08:00","dateModified":"2025-08-02T14:43:02+00:00","url":"https://visualgmq.github.io/posts/physx-cct%E8%AE%BE%E8%AE%A1%E4%B8%8E%E7%BC%BA%E9%99%B7/","headline":"PhysX CCT设计与缺陷","description":"本文基于PhysX5.5.0源码分析（不过PhysX在这方面从4.0开始几乎没有什么改动）。讲述了PhysX CharacterController的设计实现，以及其中存在的问题。\n注：PhysX的CCT实现非常简陋（如果不是工作原因不建议看源码，有这时间不如去看看UE或者Jolt这种物理引擎的实现），而且存在很多问题。我是因为工作原因才要学习，没办法。\n","inLanguage":"zh-CN","articleSection":"posts","wordCount":7157,"image":["https://visualgmq.github.io/assets/PhysXCCT%E7%AC%AC%E4%B8%80%E6%AC%A1MoveCharacter.png","https://visualgmq.github.io/assets/PhysXCCT%E7%AC%AC%E4%BA%8C%E6%AC%A1MoveCharacter.png","https://visualgmq.github.io/assets/PhysXCCT%E7%88%AC%E6%A5%BC%E6%A2%AF%E7%BC%BA%E9%99%B7.png","https://visualgmq.github.io/assets/PhysXCCTSENSOR_PASS%E7%94%A8%E9%80%94.png"],"author":{"@type":"Person","url":"https://visualgmq.github.io/"},"license":"[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)","publisher":{"@type":"Organization","name":"VisualGMQ的博客","logo":{"@type":"ImageObject","url":"https://visualgmq.github.io/icons/logo.png"},"url":"https://visualgmq.github.io/"},"mainEntityOfPage":{"@type":"WebSite","@id":"https://visualgmq.github.io/"}}</script><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@VisualGMQ"><meta property="og:title" content="PhysX CCT设计与缺陷"><meta property="og:description" content="本文基于PhysX5.5.0源码分析（不过PhysX在这方面从4.0开始几乎没有什么改动）。讲述了PhysX CharacterController的设计实现，以及其中存在的问题。
注：PhysX的CCT实现非常简陋（如果不是工作原因不建议看源码，有这时间不如去看看UE或者Jolt这种物理引擎的实现），而且存在很多问题。我是因为工作原因才要学习，没办法。
"><meta property="og:url" content="https://visualgmq.github.io/posts/physx-cct%E8%AE%BE%E8%AE%A1%E4%B8%8E%E7%BC%BA%E9%99%B7/"><meta property="og:site_name" content="VisualGMQ的博客"><meta property="og:locale" content="zh"><meta property="og:image" content="https://visualgmq.github.io/assets/PhysXCCT%E7%AC%AC%E4%B8%80%E6%AC%A1MoveCharacter.png"><meta property="og:type" content="article"><meta property="article:published_time" content="2025-08-02T17:26:12+08:00"><meta property="article:modified_time" content="2025-08-02T14:43:02+00:00"><meta property="article:section" content="posts"></head><body><div class=container><header class=header><div class=header-wrapper><div class="header-inner single"><div class=site-brand><a href=/ class=brand>VisualGMQ的博客</a></div><nav class=nav><ul class=menu id=menu><li class=menu-item><a href=/><svg viewBox="0 0 576 512" class="icon home"><path d="M280.37 148.26 96 300.11V464a16 16 0 0016 16l112.06-.29a16 16 0 0015.92-16V368a16 16 0 0116-16h64a16 16 0 0116 16v95.64a16 16 0 0016 16.05L464 480a16 16 0 0016-16V3e2L295.67 148.26a12.19 12.19.0 00-15.3.0zM571.6 251.47 488 182.56V44.05a12 12 0 00-12-12h-56a12 12 0 00-12 12v72.61L318.47 43a48 48 0 00-61 0L4.34 251.47a12 12 0 00-1.6 16.9l25.5 31A12 12 0 0045.15 301l235.22-193.74a12.19 12.19.0 0115.3.0L530.9 301a12 12 0 0016.9-1.6l25.5-31a12 12 0 00-1.7-16.93z"/></svg><span class=menu-item-name>首页</span></a></li><li class="menu-item active"><a href=/posts/><svg viewBox="0 0 512 512" class="icon archive"><path d="M32 448c0 17.7 14.3 32 32 32h384c17.7.0 32-14.3 32-32V160H32v288zm160-212c0-6.6 5.4-12 12-12h104c6.6.0 12 5.4 12 12v8c0 6.6-5.4 12-12 12H204c-6.6.0-12-5.4-12-12v-8zM480 32H32C14.3 32 0 46.3.0 64v48c0 8.8 7.2 16 16 16h480c8.8.0 16-7.2 16-16V64c0-17.7-14.3-32-32-32z"/></svg><span class=menu-item-name>文章</span></a></li><li class=menu-item><a href=/categories/><svg viewBox="0 0 512 512" class="icon th"><path d="M149.333 56v80c0 13.255-10.745 24-24 24H24c-13.255.0-24-10.745-24-24V56c0-13.255 10.745-24 24-24h101.333c13.255.0 24 10.745 24 24zm181.334 240v-80c0-13.255-10.745-24-24-24H205.333c-13.255.0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.256.0 24.001-10.745 24.001-24zm32-240v80c0 13.255 10.745 24 24 24H488c13.255.0 24-10.745 24-24V56c0-13.255-10.745-24-24-24H386.667c-13.255.0-24 10.745-24 24zm-32 80V56c0-13.255-10.745-24-24-24H205.333c-13.255.0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.256.0 24.001-10.745 24.001-24zm-205.334 56H24c-13.255.0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.255.0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zM0 376v80c0 13.255 10.745 24 24 24h101.333c13.255.0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H24c-13.255.0-24 10.745-24 24zm386.667-56H488c13.255.0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H386.667c-13.255.0-24 10.745-24 24v80c0 13.255 10.745 24 24 24zm0 160H488c13.255.0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H386.667c-13.255.0-24 10.745-24 24v80c0 13.255 10.745 24 24 24zM181.333 376v80c0 13.255 10.745 24 24 24h101.333c13.255.0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H205.333c-13.255.0-24 10.745-24 24z"/></svg><span class=menu-item-name>分类</span></a></li><li class=menu-item><a href=/tags/><svg viewBox="0 0 640 512" class="icon tags"><path d="M497.941 225.941 286.059 14.059A48 48 0 00252.118.0H48C21.49.0.0 21.49.0 48v204.118a48 48 0 0014.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882.0l204.118-204.118c18.745-18.745 18.745-49.137.0-67.882zM112 160c-26.51.0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882.0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397.0h48.721a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882z"/></svg><span class=menu-item-name>标签</span></a></li><li class=menu-item><a href=/about/><span class=menu-item-name>关于</span></a></li><li class=menu-item><a href=/projects/><span class=menu-item-name>自制程序</span></a></li><li class=menu-item><a href=/books/><span class=menu-item-name>教程</span></a></li><li class=menu-item><a id=theme-switcher href=#><svg viewBox="0 0 512 512" class="icon theme-icon-light"><path d="M193.2 104.5 242 7a18 18 0 0128 0l48.8 97.5L422.2 70A18 18 0 01442 89.8l-34.5 103.4L505 242a18 18 0 010 28l-97.5 48.8L442 422.2A18 18 0 01422.2 442l-103.4-34.5L270 505a18 18 0 01-28 0l-48.8-97.5L89.8 442A18 18 0 0170 422.2l34.5-103.4-97.5-48.8a18 18 0 010-28l97.5-48.8L70 89.8A18 18 0 0189.8 70zM256 128a128 128 0 10.01.0M256 160a96 96 0 10.01.0"/></svg><svg viewBox="0 0 512 512" class="icon theme-icon-dark"><path d="M27 412A256 256 0 10181 5a11.5 11.5.0 00-5 20A201.5 201.5.0 0142 399a11.5 11.5.0 00-15 13"/></svg></a></li><li class="menu-item search-item"><form id=search class=search role=search><label for=search-input><svg viewBox="0 0 512 512" class="icon search-icon"><path d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></label>
<input type=search id=search-input class=search-input></form><template id=search-result hidden><article class="content post"><h2 class=post-title><a class=summary-title-link></a></h2><summary class=summary></summary><div class=read-more-container><a class=read-more-link>»</a></div></article></template></li></ul></nav></div></div><input type=checkbox id=nav-toggle aria-hidden=true>
<label for=nav-toggle class=nav-toggle></label>
<label for=nav-toggle class=nav-curtain></label></header><main class="main single" id=main><div class=main-inner><article class="content post h-entry" data-align=justify data-type=posts data-toc-num=true><h1 class="post-title p-name">PhysX CCT设计与缺陷</h1><div class=post-meta><time datetime=2025-08-02T17:26:12+08:00 class="post-meta-item published dt-published"><svg viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6.0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h48c26.5.0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3.0 6-2.7 6-6z"/></svg>&nbsp;2025.8.2</time>
<time datetime=2025-08-02T14:43:02+00:00 class="post-meta-item modified dt-updated"><svg viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M4e2 64h-48V12c0-6.627-5.373-12-12-12h-40c-6.627.0-12 5.373-12 12v52H160V12c0-6.627-5.373-12-12-12h-40c-6.627.0-12 5.373-12 12v52H48C21.49 64 0 85.49.0 112v352c0 26.51 21.49 48 48 48h352c26.51.0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm-6 4e2H54a6 6 0 01-6-6V160h352v298a6 6 0 01-6 6zm-52.849-200.65L198.842 404.519c-4.705 4.667-12.303 4.637-16.971-.068l-75.091-75.699c-4.667-4.705-4.637-12.303.068-16.971l22.719-22.536c4.705-4.667 12.303-4.637 16.97.069l44.104 44.461 111.072-110.181c4.705-4.667 12.303-4.637 16.971.068l22.536 22.718c4.667 4.705 4.636 12.303-.069 16.97z"/></svg>&nbsp;2025.8.2</time>
<span class="post-meta-item wordcount"><svg viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3.0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9.0l60.1 60.1c18.8 18.7 18.8 49.1.0 67.9zM284.2 99.8 21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3.0-17l-111-111c-4.8-4.7-12.4-4.7-17.1.0zM124.1 339.9c-5.5-5.5-5.5-14.3.0-19.8l154-154c5.5-5.5 14.3-5.5 19.8.0s5.5 14.3.0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8.0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;7157</span>
<span class="post-meta-item reading-time"><svg viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5.0-2e2-89.5-2e2-2e2S145.5 56 256 56s2e2 89.5 2e2 2e2-89.5 2e2-2e2 2e2zm61.8-104.4-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6.0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;15&nbsp;</span>
<span class="post-meta-item busuanzi-page-pv" id=busuanzi_container_page_pv><svg viewBox="0 0 576 512" class="icon post-meta-icon"><path d="M288 144a110.94 110.94.0 00-31.24 5 55.4 55.4.0 017.24 27 56 56 0 01-56 56 55.4 55.4.0 01-27-7.24A111.71 111.71.0 10288 144zm284.52 97.4C518.29 135.59 410.93 64 288 64S57.68 135.64 3.48 241.41a32.35 32.35.0 000 29.19C57.71 376.41 165.07 448 288 448s230.32-71.64 284.52-177.41a32.35 32.35.0 000-29.19zM288 4e2c-98.65.0-189.09-55-237.93-144C98.91 167 189.34 112 288 112s189.09 55 237.93 144C477.1 345 386.66 4e2 288 4e2z"/></svg>&nbsp;<span id=busuanzi_value_page_pv></span></span></div><nav class=contents><h2 id=contents class=contents-title></h2><ol class=toc><li><a id=contents:cct是什么 href=#cct是什么>CCT是什么</a></li><li><a id=contents:physx-cct原理与实现 href=#physx-cct原理与实现>PhysX CCT原理与实现</a><ol><li><a id=contents:处理移动平台问题 href=#处理移动平台问题>处理移动平台问题</a><ol><li><a id=contents:检查接触物是否有效以及找到新接触物 href=#检查接触物是否有效以及找到新接触物>检查接触物是否有效，以及找到新接触物</a></li><li><a id=contents:进行移动平台操作 href=#进行移动平台操作>进行移动平台操作</a></li></ol></li><li><a id=contents:movecharacter href=#movecharacter>moveCharacter</a></li><li><a id=contents:dosweeptest href=#dosweeptest>doSweepTest</a><ol><li><a id=contents:dosweeptest缺陷 href=#dosweeptest缺陷>doSweepTest缺陷</a></li></ol></li><li><a id=contents:爬坡 href=#爬坡>爬坡</a><ol><li><a id=contents:爬坡的结果存储 href=#爬坡的结果存储>爬坡的结果存储</a></li></ol></li><li><a id=contents:滑坡无法上台阶 href=#滑坡无法上台阶>滑坡/无法上台阶</a></li><li><a id=contents:第二次movecharacter href=#第二次movecharacter>第二次moveCharacter</a><ol><li><a id=contents:walk-experiment在做什么 href=#walk-experiment在做什么>WALK EXPERIMENT在做什么</a></li></ol></li></ol></li><li><a id=contents:physx-cct缺陷 href=#physx-cct缺陷>PhysX CCT缺陷</a><ol><li><a id=contents:钻墙的缺陷 href=#钻墙的缺陷>钻墙的缺陷</a></li><li><a id=contents:preventclimbing带来的问题 href=#preventclimbing带来的问题>PreventClimbing带来的问题</a></li><li><a id=contents:爬楼梯的缺陷 href=#爬楼梯的缺陷>爬楼梯的缺陷</a></li></ol></li><li><a id=contents:sensor_pass在做什么 href=#sensor_pass在做什么>SENSOR_PASS在做什么</a></li></ol></nav><div class="post-body e-content"><p>本文基于<a href=https://github.com/NVIDIA-Omniverse/PhysX target=_blank rel=noopener>PhysX5.5.0</a>源码分析（不过PhysX在这方面从4.0开始几乎没有什么改动）。讲述了<a href=https://nvidia-omniverse.github.io/PhysX/physx/5.5.0/docs/CharacterControllers.html target=_blank rel=noopener>PhysX CharacterController</a>的设计实现，以及其中存在的问题。</p><p>注：PhysX的CCT实现非常简陋（如果不是工作原因不建议看源码，有这时间不如去看看UE或者Jolt这种物理引擎的实现），而且存在很多问题。我是因为工作原因才要学习，没办法。</p><h2 id=cct是什么><a href=#cct是什么 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:cct是什么 class=headings>CCT是什么</a></h2><p>CCT（CharacterConTroller）是角色控制器。一般用于控制玩家角色。使用纯粹的物理模拟会有很多的问题，比如如何让人物站在斜坡上，根据物理定律，需要摩擦力在静摩擦范围内物体才能停留在斜坡上。但不同的斜坡摩擦系数可能不相同，而在游戏开发时不太可能针对每个不同的斜坡调整玩家物理刚体的摩擦系数。同样，刚体模拟的底层算法可能会造成物体的抖动（比如Box2D使用的Sequential Impulse，是在刚体碰撞时使用冲量将物体推开，当物体从高处落到地面时，解算器其实是需要几帧的时间才能将物体推开，这时可能会带来几帧的物体抖动。虽然表面上看上去能够接受，但当制作第一人称游戏时，这种抖动会通过摄像机直接反馈给玩家，体验极差）。而且人物可能会做很多反物理的行为（比如蹬墙跳），这时使用纯粹的物理模拟会增大开发难度。</p><p>而CCT就是完全为角色量身定制的功能。CCT和游戏玩法强相关，虽然现代物理引擎基本上都会提供一个CCT功能，但大部分时候还是要根据游戏进行魔改或者完全重写。绝大部分的CCT不使用物理模拟，CCT本质上是一个几何形体（一般是胶囊体，立方体或者圆柱体），使用场景查询(SceneQuery)功能配合一些碰撞检测算法（用于在物体相交时进行挤出）实现。</p><p>通用CCT一般处理如下问题</p><ol><li>MoveAndSlide：最核心的功能，分为两步：<ol><li>Move：对CCT进行移动</li><li>Slide：移动过程中使用几何扫略（Sweep），如果碰到了物体到物体之后贴着物体移动（Slide）</li></ol></li><li>处理爬坡问题：可以爬坡，但太陡峭的坡爬不上去，或者站在上面会滑下来</li><li>处理上楼梯问题：可以爬低矮的楼梯，但太高的楼梯无法爬上去</li><li>处理移动平台问题：当人物站在移动平台上，应该要随着平台一起移动</li><li>处理和其他CCT碰撞的问题：角色之间如果碰撞应该如何解决（直接穿过去还是阻挡等）</li><li>处理和非CCT的动态物碰撞问题：比如角色被巨石挤开</li></ol><h2 id=physx-cct原理与实现><a href=#physx-cct原理与实现 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:physx-cct原理与实现 class=headings>PhysX CCT原理与实现</a></h2><p>PhysX CCT本身是一个不进行模拟的Kinematic刚体，实现总共分为三步：</p><ol><li><p>检测当前是否站在平台上，处理移动平台问题</p></li><li><p>做爬坡和爬楼梯（以后统称为爬坡）</p></li></ol><p><img src=/assets/PhysXCCT%E7%AC%AC%E4%B8%80%E6%AC%A1MoveCharacter.png alt=PhysXCCT爬楼梯></p><ol start=3><li>如果爬坡梯失败，使用正常的MoveAndSlide：</li></ol><p><img src=/assets/PhysXCCT%E7%AC%AC%E4%BA%8C%E6%AC%A1MoveCharacter.png alt=PhysXCCT爬楼梯></p><p>我们这里只分析对胶囊体的移动（PhysX还支持立方体，但是情况比胶囊体简单所以不再分析）。</p><p>胶囊体移动的源码在</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// CctCharacterController.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>PxControllerCollisionFlags</span> <span class=n>Controller</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>SweptVolume</span><span class=o>&amp;</span> <span class=n>volume</span><span class=p>,</span> <span class=k>const</span> <span class=n>PxVec3</span><span class=o>&amp;</span> <span class=n>originalDisp</span><span class=p>,</span> <span class=n>PxF32</span> <span class=n>minDist</span><span class=p>,</span> <span class=n>PxF32</span> <span class=n>elapsedTime</span><span class=p>,</span> <span class=k>const</span> <span class=n>PxControllerFilters</span><span class=o>&amp;</span> <span class=n>filters</span><span class=p>,</span> <span class=k>const</span> <span class=n>PxObstacleContext</span><span class=o>*</span> <span class=n>obstacleContext</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>constrainedClimbingMode</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div><p>PhysX不是直接移动CCT所用的刚体，而是先构造一个<code>SweepTest</code>（里面存储着CCT形状和其他信息），对整个<code>SweepTest</code>做移动，最后再将位置同步回CCT刚体。</p><p>其主要流程为：</p><ol><li>使用<code>findTouchedObject</code>（以及后面<code>moveCharacter</code>中<code>DOWN_PASS</code>）找到现在站的移动平台，并且使用<code>rideOnTouchedObject</code>处理移动</li><li>第一次<code>moveCharacter</code>处理爬坡</li><li>如果第一次<code>moveCharacter</code>失败，将胶囊体回滚到最开始的位置，进行第二次<code>moveCharacter</code>走正常move and slide</li></ol><h3 id=处理移动平台问题><a href=#处理移动平台问题 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:处理移动平台问题 class=headings>处理移动平台问题</a></h3><p>接触到的物体保存在<code>SweepTest::mTouchedActor</code>和<code>SweepTet::mTouchedShape</code>中。接触物体的位置保存在<code>SweepTest::mTouchedPosShape_World</code>和<code>SweepTet::mTouchedPosShape_Local</code>中。因为这是<code>move</code>的开头，所以此时保存的是上一次<code>move</code>的接触物体。</p><h4 id=检查接触物是否有效以及找到新接触物><a href=#检查接触物是否有效以及找到新接触物 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:检查接触物是否有效以及找到新接触物 class=headings>检查接触物是否有效，以及找到新接触物</a></h4><p>首先判断当前接触物体是否还生效：</p><ol><li>查看<code>mTouchedActor</code>和<code>mTouchedShape</code>是否还存在，以及<code>mTouchedShape</code>是否还在<code>mTouchedActor</code>上</li><li>使用用户自定义的Filter过滤</li><li>检查<code>mTouchedShape</code>是否还能进行场景查询（<code>PxShapeFlag::eSCENE_QUERY_SHAPE</code>）</li></ol><p>如果经过检查发现失效，使用<code>findTouchedObject</code>获得当前的接触物体以及物体位置。</p><p><code>findTouchedObject</code>只会检测动态物。方法是从胶囊体的中心向下打射线，长度为胶囊体半高。然后取得第一个打到的物体。</p><p>如果有<code>UserObstacle</code>，再对<code>UserObstacle</code>进行同样操作。</p><h4 id=进行移动平台操作><a href=#进行移动平台操作 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:进行移动平台操作 class=headings>进行移动平台操作</a></h4><p>此时如果仍旧存在接触物，使用<code>rideOnTouchedObject</code>进行跟随接触物移动操作。很简单，就是把物体当前的位置和之前记录的位置差值加到<code>originalDisp</code>上。也就是说这一步并不真正的移动胶囊体，而是改变它的移动向量。</p><h3 id=movecharacter><a href=#movecharacter class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:movecharacter class=headings>moveCharacter</a></h3><p>接下来要做<code>moveCharacter</code>。<code>moveCharacter</code>内部其实是个状态机，根据设置的状态，里面依次有至多五次的<code>doSweepTest</code>：</p><ol><li><code>UP_PASS</code>：当CCT需要向上移动时，做垂直向上的<code>doSweepTest</code>（其实是沿着CCT的<code>up_direction</code>）</li><li><code>SIDE_PASS</code>：当CCT需要向前移动时，做向前的<code>doSweepTest</code></li><li><code>SENSOR_PASS</code>：当CCT的攀爬模式是<code>ConstarintClimbing</code>时，额外做一次向前的探测（但是不影响CCT位置）</li><li><code>DOWN_PASS</code>：当CCT需要下落时，做向下的<code>doSweepTest</code></li><li><code>WALK_EXPERIMENT</code>：如果当前是<code>WALK_EXPRERIMENT</code>状态，做一次向上的恢复移动</li></ol><p>其中1, 2, 3, 4会出现在爬坡的<code>moveCharacter</code>中。而4, 5会出现在第二次<code>moveCharacter</code>中</p><h3 id=dosweeptest><a href=#dosweeptest class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:dosweeptest class=headings>doSweepTest</a></h3><p><code>doSweepTest</code>其实是做Move，然后看情况要不要Slide。它的步骤如下：</p><ol><li><p>使用<code>computeTemporalBox</code>得到胶囊体前向方向的扫略框，然后使用<code> updateTouchedGeoms</code>找到可能碰撞的物体</p><p>![沿着前进方向的包围盒](/assets/PhysX CCT前进方向包围盒.png)</p></li><li><p>对扫略到的所有碰撞体进行Sweep查询。找到最近碰撞到的物体</p></li><li><p>如果没有碰撞到物体，移动胶囊体到指定位置</p></li><li><p>如果开启了<code>OverlapRecovery</code>，则将物体从重叠的物体中挤出（使用<code>computeMTD</code>得到最小分离向量，然后使用这个向量移动CCT。</p></li><li><p>如果是<code>DOWN_PASS</code>，记录移动平台相关信息</p></li><li><p>执行move and slide</p></li></ol><h4 id=dosweeptest缺陷><a href=#dosweeptest缺陷 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:dosweeptest缺陷 class=headings>doSweepTest缺陷</a></h4><p>这里有一些问题需要注意：</p><p><code>doSweepTest</code>的上述逻辑是套在一个while循环中：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>PxVec3</span> <span class=n>current_position</span> <span class=o>=</span> <span class=n>swept_volume</span><span class=p>.</span><span class=n>center</span>
</span></span><span class=line><span class=cl><span class=n>PxVec3</span> <span class=n>target_position</span> <span class=o>=</span> <span class=n>swept_volume</span><span class=p>.</span><span class=n>center</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=p>(</span><span class=n>max_iter</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=err>找到附近的碰撞体</span>
</span></span><span class=line><span class=cl>    <span class=nf>if</span> <span class=p>(</span><span class=o>!</span><span class=err>碰撞到物体</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>current_position</span> <span class=o>=</span> <span class=n>target_position</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>CCT和其他物体重合</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=err>计算</span><span class=n>MTD并移动CCT</span>
</span></span><span class=line><span class=cl>        <span class=n>retur</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>DOWN_PASS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	    <span class=err>记录移动平台相关信息</span>   
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>sweepPass</span><span class=o>==</span><span class=n>SWEEP_PASS_DOWN</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>stopSliding</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>NbCollisions</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>max_iter</span> <span class=o>+=</span> <span class=mi>9</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>C</span><span class=p>.</span><span class=n>mDistance</span><span class=o>&gt;</span><span class=n>DynSkin</span><span class=p>)</span> <span class=c1>// (*1)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>add</span><span class=p>(</span><span class=n>current_position</span><span class=p>,</span> <span class=n>currentDirection</span><span class=o>*</span><span class=p>(</span><span class=n>C</span><span class=p>.</span><span class=n>mDistance</span><span class=o>-</span><span class=n>DynSkin</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>执行</span><span class=n>move</span> <span class=n>and</span> <span class=n>slide</span><span class=err>，结果位置存在</span><span class=n>target_position中</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>swept_volume</span><span class=p>.</span><span class=n>center</span> <span class=o>=</span> <span class=n>current_position</span>
</span></span></code></pre></td></tr></table></div></div></div><p>如果<code>max_iter == 1</code>，那么CCT就只是移动，而不进行slide（如果没碰到物体走步骤3，如果碰到了走<code>(*1)</code>逻辑移动<code>currentPosition</code>）。</p><p>这里只有步骤4会直接设置CCT位置并返回。但是重叠恢复操作也不是很正确。执行此操作的前提是：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=n>mUserParams</span><span class=p>.</span><span class=n>mOverlapRecovery</span> <span class=o>&amp;&amp;</span> <span class=n>C</span><span class=p>.</span><span class=n>mDistance</span><span class=o>==</span><span class=mf>0.0f</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div><p>用户需要开启重叠恢复功能并且有物体重叠。而<code>C.mDistance == 0.0f</code>取决于步骤2中的碰撞体查询：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>CollideGeoms</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>swept_volume</span><span class=p>,</span> <span class=n>mGeomStream</span><span class=p>,</span> <span class=n>currentPosition</span><span class=p>,</span> <span class=n>currentDirection</span><span class=p>,</span> <span class=n>C</span><span class=p>,</span> <span class=o>!</span><span class=n>mUserParams</span><span class=p>.</span><span class=n>mOverlapRecovery</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// no collision found =&gt; move to desired position
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>currentPosition</span> <span class=o>=</span> <span class=n>targetOrientation</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>在<code>CollideGeoms</code>中会找到碰撞到的物体，当某个物体和CCT重合时，会使用<code>shouldApplyRecoveryModule</code>函数检测此物体是否能被视为挤出物体。</p><p>然而<code>shouldApplyRecoveryModule</code>的逻辑却是这样的：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>static</span> <span class=kt>bool</span> <span class=nf>shouldApplyRecoveryModule</span><span class=p>(</span><span class=k>const</span> <span class=n>PxRigidActor</span><span class=o>&amp;</span> <span class=n>rigidActor</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=n>PxType</span> <span class=n>type</span> <span class=o>=</span> <span class=n>rigidActor</span><span class=p>.</span><span class=n>getConcreteType</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>type</span><span class=o>==</span><span class=n>PxConcreteType</span><span class=o>::</span><span class=n>eRIGID_STATIC</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>type</span><span class=o>!=</span><span class=n>PxConcreteType</span><span class=o>::</span><span class=n>eRIGID_DYNAMIC</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=k>const</span> <span class=n>PxRigidBody</span><span class=o>&amp;&gt;</span><span class=p>(</span><span class=n>rigidActor</span><span class=p>).</span><span class=n>getRigidBodyFlags</span><span class=p>()</span> <span class=o>&amp;</span> <span class=n>PxRigidBodyFlag</span><span class=o>::</span><span class=n>eKINEMATIC</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>只有在物体是Static或者Kinematic的时候才被视为可以挤出，对于任何动态物都不会做这个操作！这意味着CCT会和场景中的动态物穿过去！</p><p><video src="/assets/PhysXCCT MTD失效.mp4" controls></video></p><p>将这里的最后一行改为返回<code>true</code>就可以了：</p><p><video src="/assets/PhysXCCT MTD生效.mp4" controls></video></p><h3 id=爬坡><a href=#爬坡 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:爬坡 class=headings>爬坡</a></h3><p>了解了<code>doSweepTest</code>之后我们可以来看爬坡操作了<img src=/assets/PhysXCCT%E7%AC%AC%E4%B8%80%E6%AC%A1MoveCharacter.png alt=PhysXCCT爬楼梯></p><p>爬坡操作是做三次<code>doSweepTest</code>。首先将CCT移动的向量<code>disp</code>按<code>up_direction</code>正交拆分成<code>normal_disp</code>和<code>side_disp</code>。<code>UP_PASS</code>和<code>DOWN_PASS</code>都只向<code>normal_disp</code>方向（或反方向）移动。<code>SIDE_PASS</code>和<code>SENSOR_PASS</code>会按照<code>side_disp</code>移动。</p><p>由于<code>doSweepTest</code>到底做不做Slide是受到<code>max_iter</code>影响的，所以这里我们要着重看这个量的值</p><ol><li><p>对于<code>UP_PASS</code>是这样的：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=n>mUserParams</span><span class=p>.</span><span class=n>mPreventVerticalSlidingAgainstCeiling</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>maxIterUp</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=n>maxIterUp</span> <span class=o>=</span> <span class=n>isAlmostZero</span><span class=p>(</span><span class=n>SideVector</span><span class=p>)</span> <span class=o>?</span> <span class=nl>maxIter</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div></div><p><code>PreventVerticalSlidingAgainstCeiling</code>的用法是如果头顶的天花板是斜的，那么不会被沿着天花板的斜面move and slide从而导致人物跳跃之后向前移动。</p></li><li><p>对于<code>SIDE_PASS</code>是这样的：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>const</span> <span class=n>PxU32</span> <span class=n>maxIter</span> <span class=o>=</span> <span class=n>MAX_ITER</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>PxU32</span> <span class=n>maxIterSides</span> <span class=o>=</span> <span class=n>maxIter</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div></div><p><code>MAX_ITER</code>是常量为10，也就是说<code>SIDE_PASS</code>一定会做move and slide</p><p><code>SENSOR_PASS</code>不改变CCT位置，暂时不讨论。</p></li><li><p>对于<code>DOWN_PASS</code>是这样的：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>const</span> <span class=n>PxU32</span> <span class=n>maxIterDown</span> <span class=o>=</span> <span class=p>((</span><span class=n>mFlags</span> <span class=o>&amp;</span> <span class=n>STF_WALK_EXPERIMENT</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>mUserParams</span><span class=p>.</span><span class=n>mNonWalkableMode</span><span class=o>==</span><span class=n>PxControllerNonWalkableMode</span><span class=o>::</span><span class=n>ePREVENT_CLIMBING_AND_FORCE_SLIDING</span><span class=p>)</span> <span class=o>?</span> <span class=nl>maxIter</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div></div><p><code>STF_WALK_EXPERIMENT</code>只有在进入第二次<code>moveCharacter</code>时才会设置。<code>PREVENT_CLIMBING_AND_FORCE_SLIDING</code>是一个用于设置，用途是当CCT站在斜坡上时，强制让CCT下滑（这个后面会说）。</p><p>这段逻辑是说在爬坡逻辑中永远为1，在第二次<code>moveCharacter</code>中如果你接受强制下滑操作，设为10做move and slide。</p><p>但要注意到，在<code>doSweepTest</code>中也有影响<code>max_iter</code>的因素：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>while</span> <span class=p>(</span><span class=n>max_iter</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 其他操作
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>sweepPass</span><span class=o>==</span><span class=n>SWEEP_PASS_DOWN</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>stopSliding</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>NbCollisions</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>max_iter</span> <span class=o>+=</span> <span class=mi>9</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 其他操作
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>这里如果<code>stopSliding == false</code>也会强制下滑。这个<code>stopSliding</code>是当碰到物体（非UserBox和UserCapusle）时：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=n>sweepPass</span><span class=o>!=</span><span class=n>SWEEP_PASS_SENSOR</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>PxU32</span> <span class=n>behaviorFlags</span> <span class=o>=</span> <span class=n>shapeHitCallback</span><span class=p>(</span><span class=n>userHitData</span><span class=p>,</span> <span class=n>C</span><span class=p>,</span> <span class=n>currentDirection</span><span class=p>,</span> <span class=n>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>stopSliding</span> <span class=o>=</span> <span class=p>(</span><span class=n>behaviorFlags</span> <span class=o>&amp;</span> <span class=n>PxControllerBehaviorFlag</span><span class=o>::</span><span class=n>eCCT_SLIDE</span><span class=p>)</span><span class=o>==</span><span class=mi>0</span><span class=p>;</span>		<span class=c1>// (*)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>而<code>shapeHitCallback</code>则为：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>PxU32</span> <span class=n>Cct</span><span class=o>::</span><span class=n>shapeHitCallback</span><span class=p>(</span><span class=k>const</span> <span class=n>InternalCBData_OnHit</span><span class=o>*</span> <span class=n>userData</span><span class=p>,</span> <span class=k>const</span> <span class=n>SweptContact</span><span class=o>&amp;</span> <span class=n>contact</span><span class=p>,</span> <span class=k>const</span> <span class=n>PxVec3</span><span class=o>&amp;</span> <span class=n>dir</span><span class=p>,</span> <span class=kt>float</span> <span class=n>length</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>Controller</span><span class=o>*</span> <span class=n>controller</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=k>const</span> <span class=n>PxInternalCBData_OnHit</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>userData</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>controller</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 这些是当碰撞到物体时调用用户的回调函数进行report
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>PxControllerShapeHit</span> <span class=n>hit</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>fillCCTHit</span><span class=p>(</span><span class=n>hit</span><span class=p>,</span> <span class=n>contact</span><span class=p>,</span> <span class=n>dir</span><span class=p>,</span> <span class=n>length</span><span class=p>,</span> <span class=n>controller</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>hit</span><span class=p>.</span><span class=n>shape</span>			<span class=o>=</span> <span class=k>const_cast</span><span class=o>&lt;</span><span class=n>PxShape</span><span class=o>*&gt;</span><span class=p>(</span><span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=k>const</span> <span class=n>PxShape</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>contact</span><span class=p>.</span><span class=n>mGeom</span><span class=o>-&gt;</span><span class=n>mTGUserData</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=n>hit</span><span class=p>.</span><span class=n>actor</span>			<span class=o>=</span> <span class=k>const_cast</span><span class=o>&lt;</span><span class=n>PxRigidActor</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>contact</span><span class=p>.</span><span class=n>mGeom</span><span class=o>-&gt;</span><span class=n>mActor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>hit</span><span class=p>.</span><span class=n>triangleIndex</span>	<span class=o>=</span> <span class=n>contact</span><span class=p>.</span><span class=n>mTriangleIndex</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>controller</span><span class=o>-&gt;</span><span class=n>mReportCallback</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>controller</span><span class=o>-&gt;</span><span class=n>mReportCallback</span><span class=o>-&gt;</span><span class=n>onShapeHit</span><span class=p>(</span><span class=n>hit</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 这里才是决定是否下滑的逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>PxControllerBehaviorCallback</span><span class=o>*</span> <span class=n>behaviorCB</span> <span class=o>=</span> <span class=n>controller</span><span class=o>-&gt;</span><span class=n>mBehaviorCallback</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>behaviorCB</span> <span class=o>?</span> <span class=n>behaviorCB</span><span class=o>-&gt;</span><span class=n>getBehaviorFlags</span><span class=p>(</span><span class=o>*</span><span class=n>hit</span><span class=p>.</span><span class=n>shape</span><span class=p>,</span> <span class=o>*</span><span class=n>hit</span><span class=p>.</span><span class=n>actor</span><span class=p>)</span> <span class=o>:</span> <span class=n>defaultBehaviorFlags</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>最后一行的<code>behaviorCB->getBehaviorFlags</code>是用户定义的CCT Behavior操作。默认是<code>stopSliding</code>的。</p><p>也就是说，用户的行为会覆盖掉<code>ePREVENT_CLIMBING_AND_FORCE_SLIDING</code>设置（因为他会强制``max_iter += 9`从而move and slide）。</p><h4 id=爬坡的结果存储><a href=#爬坡的结果存储 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:爬坡的结果存储 class=headings>爬坡的结果存储</a></h4><p>如果爬坡失败。整个CCT会回到爬坡之前（也就是最开始的位置），然后做第二次<code>moveCharacter</code>。但是爬坡依旧记录了一些有用的信息。主要是<code>STF_XXX</code>标志位：</p><ul><li><p><code>STF_VALIDATE_TRIANGLE_SIDE</code>：做<code>SIDE_PASS</code>时碰到了物体</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// doSweepTest的while循环中：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span><span class=p>(</span><span class=n>sweepPass</span><span class=o>==</span><span class=n>SWEEP_PASS_SIDE</span> <span class=o>||</span> <span class=n>sweepPass</span><span class=o>==</span><span class=n>SWEEP_PASS_SENSOR</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>((</span><span class=n>touchedActor</span><span class=o>-&gt;</span><span class=n>getConcreteType</span><span class=p>()</span> <span class=o>==</span> <span class=n>PxConcreteType</span><span class=o>::</span><span class=n>eRIGID_STATIC</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>C</span><span class=p>.</span><span class=n>mInternalIndex</span><span class=o>!=</span><span class=n>PX_INVALID_U32</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果碰到了物体，记录下信息
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mFlags</span> <span class=o>|=</span> <span class=n>STF_VALIDATE_TRIANGLE_SIDE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=n>PxTriangle</span><span class=o>&amp;</span> <span class=n>touchedTri</span> <span class=o>=</span> <span class=n>mWorldTriangles</span><span class=p>.</span><span class=n>getTriangle</span><span class=p>(</span><span class=n>C</span><span class=p>.</span><span class=n>mInternalIndex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>touchedTri</span><span class=p>.</span><span class=n>normal</span><span class=p>(</span><span class=n>mContactNormalSidePass</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>mUserParams</span><span class=p>.</span><span class=n>mPreventVerticalSlidingAgainstCeiling</span> <span class=o>&amp;&amp;</span> <span class=n>mContactNormalSidePass</span><span class=p>.</span><span class=n>dot</span><span class=p>(</span><span class=n>mUserParams</span><span class=p>.</span><span class=n>mUpDirection</span><span class=p>)</span><span class=o>&lt;</span><span class=mf>0.0f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>preventVerticalMotion</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></li><li><p><code>STF_VALIDATE_TRIANGLE_DOWN</code>：做<code>DOWN_SIDE</code>时碰到了物体</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// doSweepTest的while循环中：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span><span class=p>(</span><span class=n>sweepPass</span><span class=o>==</span><span class=n>SWEEP_PASS_DOWN</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>mFlags</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=p>(</span><span class=n>STF_TOUCH_OTHER_CCT</span><span class=o>|</span><span class=n>STF_TOUCH_OBSTACLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#ifdef USE_CONTACT_NORMAL_FOR_SLOPE_TEST
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=n>mFlags</span> <span class=o>|=</span> <span class=n>STF_VALIDATE_TRIANGLE_DOWN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mContactNormalDownPass</span> <span class=o>=</span> <span class=n>C</span><span class=p>.</span><span class=n>mWorldNormal</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#else
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>((</span><span class=n>touchedActor</span><span class=o>-&gt;</span><span class=n>getConcreteType</span><span class=p>()</span> <span class=o>==</span> <span class=n>PxConcreteType</span><span class=o>::</span><span class=n>eRIGID_STATIC</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>C</span><span class=p>.</span><span class=n>mInternalIndex</span><span class=o>!=</span><span class=n>PX_INVALID_U32</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 这里记录下DOWN_PASS时碰到的物体
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mFlags</span> <span class=o>|=</span> <span class=n>STF_VALIDATE_TRIANGLE_DOWN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=n>PxTriangle</span><span class=o>&amp;</span> <span class=n>touchedTri</span> <span class=o>=</span> <span class=n>mWorldTriangles</span><span class=p>.</span><span class=n>getTriangle</span><span class=p>(</span><span class=n>C</span><span class=p>.</span><span class=n>mInternalIndex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=n>PxVec3</span><span class=o>&amp;</span> <span class=n>upDirection</span> <span class=o>=</span> <span class=n>mUserParams</span><span class=p>.</span><span class=n>mUpDirection</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=kt>float</span> <span class=n>dp0</span> <span class=o>=</span> <span class=n>touchedTri</span><span class=p>.</span><span class=n>verts</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>dot</span><span class=p>(</span><span class=n>upDirection</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=kt>float</span> <span class=n>dp1</span> <span class=o>=</span> <span class=n>touchedTri</span><span class=p>.</span><span class=n>verts</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=n>dot</span><span class=p>(</span><span class=n>upDirection</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=kt>float</span> <span class=n>dp2</span> <span class=o>=</span> <span class=n>touchedTri</span><span class=p>.</span><span class=n>verts</span><span class=p>[</span><span class=mi>2</span><span class=p>].</span><span class=n>dot</span><span class=p>(</span><span class=n>upDirection</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>float</span> <span class=n>dpmin</span> <span class=o>=</span> <span class=n>dp0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>dpmin</span> <span class=o>=</span> <span class=n>physx</span><span class=o>::</span><span class=n>intrinsics</span><span class=o>::</span><span class=n>selectMin</span><span class=p>(</span><span class=n>dpmin</span><span class=p>,</span> <span class=n>dp1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>dpmin</span> <span class=o>=</span> <span class=n>physx</span><span class=o>::</span><span class=n>intrinsics</span><span class=o>::</span><span class=n>selectMin</span><span class=p>(</span><span class=n>dpmin</span><span class=p>,</span> <span class=n>dp2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>float</span> <span class=n>dpmax</span> <span class=o>=</span> <span class=n>dp0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>dpmax</span> <span class=o>=</span> <span class=n>physx</span><span class=o>::</span><span class=n>intrinsics</span><span class=o>::</span><span class=n>selectMax</span><span class=p>(</span><span class=n>dpmax</span><span class=p>,</span> <span class=n>dp1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>dpmax</span> <span class=o>=</span> <span class=n>physx</span><span class=o>::</span><span class=n>intrinsics</span><span class=o>::</span><span class=n>selectMax</span><span class=p>(</span><span class=n>dpmax</span><span class=p>,</span> <span class=n>dp2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>PxExtendedVec3</span> <span class=n>cacheCenter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>getCenter</span><span class=p>(</span><span class=n>mCacheBounds</span><span class=p>,</span> <span class=n>cacheCenter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=kt>float</span> <span class=n>offset</span> <span class=o>=</span> <span class=n>upDirection</span><span class=p>.</span><span class=n>dot</span><span class=p>(</span><span class=n>toVec3</span><span class=p>(</span><span class=n>cacheCenter</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>mTouchedTriMin</span> <span class=o>=</span> <span class=n>dpmin</span> <span class=o>+</span> <span class=n>offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mTouchedTriMax</span> <span class=o>=</span> <span class=n>dpmax</span> <span class=o>+</span> <span class=n>offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>touchedTri</span><span class=p>.</span><span class=n>normal</span><span class=p>(</span><span class=n>mContactNormalDownPass</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=n>touchedShapeOut</span> <span class=o>=</span> <span class=k>const_cast</span><span class=o>&lt;</span><span class=n>PxShape</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>touchedShape</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>touchedActorOut</span> <span class=o>=</span> <span class=n>touchedActor</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>PxTransform</span> <span class=n>shapeTransform</span> <span class=o>=</span> <span class=n>getShapeGlobalPose</span><span class=p>(</span><span class=o>*</span><span class=n>touchedShape</span><span class=p>,</span> <span class=o>*</span><span class=n>touchedActor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>PxVec3</span> <span class=n>worldPos</span> <span class=o>=</span> <span class=n>toVec3</span><span class=p>(</span><span class=n>C</span><span class=p>.</span><span class=n>mWorldPos</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mTouchedPosShape_World</span> <span class=o>=</span> <span class=n>worldPos</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mTouchedPosShape_Local</span> <span class=o>=</span> <span class=n>shapeTransform</span><span class=p>.</span><span class=n>transformInv</span><span class=p>(</span><span class=n>worldPos</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></li><li><p><code>STF_TOUCH_OTHER_CCT</code>和<code>STF_TOUCH_OBSTACLE</code>：是否碰到了其他的CCT或用户自定义障碍物。也是在<code>DOWN_PASS</code>的时候：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// doSweepTest的while循环中：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span><span class=p>(</span><span class=n>sweepPass</span><span class=o>==</span><span class=n>SWEEP_PASS_DOWN</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>touchedObstacle</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mFlags</span> <span class=o>|=</span> <span class=n>STF_TOUCH_OBSTACLE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>mTouchedObstacleHandle</span> <span class=o>=</span> <span class=n>touchedObstacleHandle</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>gUseLocalSpace</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mTouchedPos</span> <span class=o>=</span> <span class=n>toVec3</span><span class=p>(</span><span class=n>touchedObstacle</span><span class=o>-&gt;</span><span class=n>mPos</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mTouchedPosObstacle_World</span> <span class=o>=</span> <span class=n>toVec3</span><span class=p>(</span><span class=n>C</span><span class=p>.</span><span class=n>mWorldPos</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>mTouchedPosObstacle_Local</span> <span class=o>=</span> <span class=n>worldToLocal</span><span class=p>(</span><span class=o>*</span><span class=n>touchedObstacle</span><span class=p>,</span> <span class=n>C</span><span class=p>.</span><span class=n>mWorldPos</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mFlags</span> <span class=o>|=</span> <span class=n>STF_TOUCH_OTHER_CCT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></li></ul><h3 id=滑坡无法上台阶><a href=#滑坡无法上台阶 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:滑坡无法上台阶 class=headings>滑坡/无法上台阶</a></h3><p>在爬坡的<code>moveCharacter</code>中，做完<code>DOWN_PASS</code>之后会进行一次能否爬坡的检测：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=n>doSweepTest</span><span class=p>(</span><span class=n>userData</span><span class=p>,</span> <span class=n>userHitData</span><span class=p>,</span> <span class=n>userObstacles</span><span class=p>,</span> <span class=n>volume</span><span class=p>,</span> <span class=n>DownVector</span><span class=p>,</span> <span class=n>SideVector</span><span class=p>,</span> <span class=n>maxIterDown</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>NbCollisions</span><span class=p>,</span> <span class=n>min_dist</span><span class=p>,</span> <span class=n>filters</span><span class=p>,</span> <span class=n>SWEEP_PASS_DOWN</span><span class=p>,</span> <span class=n>touchedActor</span><span class=p>,</span> <span class=n>touchedShape</span><span class=p>,</span> <span class=n>contextID</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>NbCollisions</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>dir_dot_up</span><span class=o>&lt;=</span><span class=mf>0.0f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>CollisionFlags</span> <span class=o>|=</span> <span class=n>PxControllerCollisionFlag</span><span class=o>::</span><span class=n>eCOLLISION_DOWN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 站在CCT或者自定义障碍物上不算滑坡
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span><span class=p>(</span><span class=n>mUserParams</span><span class=p>.</span><span class=n>mHandleSlope</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=n>mFlags</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>STF_TOUCH_OTHER_CCT</span><span class=o>|</span><span class=n>STF_TOUCH_OBSTACLE</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 如果SIDE_PASS碰到了物体，并且testSlope成功,说明无法爬坡
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 注意testSlope的功能是检测是否不能爬坡。这里使用SIDE_PASS时碰到的面法向量做检测
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span><span class=p>((</span><span class=n>mFlags</span> <span class=o>&amp;</span> <span class=n>STF_VALIDATE_TRIANGLE_SIDE</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>testSlope</span><span class=p>(</span><span class=n>mContactNormalSidePass</span><span class=p>,</span> <span class=n>upDirection</span><span class=p>,</span> <span class=n>mUserParams</span><span class=p>.</span><span class=n>mSlopeLimit</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 然后检测是否能爬楼梯
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span><span class=p>(</span><span class=n>constrainedClimbingMode</span> <span class=o>&amp;&amp;</span> <span class=n>PxExtended</span><span class=p>(</span><span class=n>mContactPointHeight</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>originalBottomPoint</span> <span class=o>+</span> <span class=n>PxExtended</span><span class=p>(</span><span class=n>stepOffset</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>mFlags</span> <span class=o>|=</span> <span class=n>STF_HIT_NON_WALKABLE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>mFlags</span> <span class=o>&amp;</span> <span class=n>STF_WALK_EXPERIMENT</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                        <span class=k>return</span> <span class=n>CollisionFlags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>注意点：</p><ol><li><code>testSlope</code>的算法是使用碰撞的面法线和用户设置的能够爬坡斜率做判断。并且这里使用的是<code>mContactNormalSidePass</code>而不是<code>mContactNormalDownPass</code>（下文会解释）</li><li>如果坡和楼梯都上不去，设置<code>STF_HIT_NON_WALKABLE</code>标识碰到了无法行走的地方</li></ol><h3 id=第二次movecharacter><a href=#第二次movecharacter class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:第二次movecharacter class=headings>第二次moveCharacter</a></h3><p>经过爬坡逻辑之后，如果发现碰到了无法走到的区域，回滚CCT位置，使用最开始的移动方向做move and slide：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=n>mCctModule</span><span class=p>.</span><span class=n>mFlags</span> <span class=o>&amp;</span> <span class=n>STF_HIT_NON_WALKABLE</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// STF_WALK_EXPERIMENT只有在第二次moveCharacter才会设置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mCctModule</span><span class=p>.</span><span class=n>mFlags</span> <span class=o>|=</span> <span class=n>STF_WALK_EXPERIMENT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 回滚CCT位置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>volume</span><span class=p>.</span><span class=n>mCenter</span> <span class=o>=</span> <span class=n>Backup</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 这个操作后面会说，是个有问题的操作
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>PxVec3</span> <span class=n>xpDisp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>mUserParams</span><span class=p>.</span><span class=n>mNonWalkableMode</span><span class=o>==</span><span class=n>PxControllerNonWalkableMode</span><span class=o>::</span><span class=n>ePREVENT_CLIMBING_AND_FORCE_SLIDING</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>PxVec3</span> <span class=n>tangent_compo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>decomposeVector</span><span class=p>(</span><span class=n>xpDisp</span><span class=p>,</span> <span class=n>tangent_compo</span><span class=p>,</span> <span class=n>disp</span><span class=p>,</span> <span class=n>upDirection</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=n>xpDisp</span> <span class=o>=</span> <span class=n>disp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 执行第二次moveCharacter
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>collisionFlags</span> <span class=o>=</span> <span class=n>mCctModule</span><span class=p>.</span><span class=n>moveCharacter</span><span class=p>(</span><span class=o>&amp;</span><span class=n>findGeomData</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>userHitData</span><span class=p>,</span> <span class=n>volume</span><span class=p>,</span> <span class=n>xpDisp</span><span class=p>,</span> <span class=n>userObstacles</span><span class=p>,</span> <span class=n>minDist</span><span class=p>,</span> <span class=n>filters</span><span class=p>,</span> <span class=n>constrainedClimbingMode</span><span class=p>,</span> <span class=n>standingOnMoving</span><span class=p>,</span> <span class=n>touchedActor</span><span class=p>,</span> <span class=n>touchedShape</span><span class=p>,</span> <span class=n>getContextId</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mCctModule</span><span class=p>.</span><span class=n>mFlags</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>STF_WALK_EXPERIMENT</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>先来看第二次<code>moveCharacter</code>做了什么。由于设置了<code>STF_WALK_EXPERIMENT</code>，导致内部逻辑变化了：</p><ol><li>做<code>SIDE_PASS</code></li><li>做<code>DOWN_PASS</code></li><li>如果仍旧无法爬坡，做<code>WALK_EXPERIMENT</code>的<code>doSweepTest</code>（这个后面再解释）去解决一些问题</li></ol><h4 id=walk-experiment在做什么><a href=#walk-experiment在做什么 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:walk-experiment在做什么 class=headings>WALK EXPERIMENT在做什么</a></h4><p>前面说过，<code>DOWN_PASS</code>后检测爬坡的方式是使用<code>mContactNormalSlidePass</code>，可能有人会问那如果<code>SIDE_PASS</code>时没碰到物体，<code>DOWN_PASS</code>时碰到了斜坡不是不会下滑了吗（因为爬坡检测通过了）。这就是<code>WALK_EXPERIMENT</code>做的事情。</p><p>这个时候<code>WALK_EXPERIMENT</code>的<code>doSweepTest</code>强制把CCT往下移动，移动距离正是他移动前后的高度差：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// ==========[ WALK EXPERIMENT ]===========================
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mFlags</span> <span class=o>|=</span> <span class=n>STF_NORMALIZE_RESPONSE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>PxExtended</span> <span class=n>tmp</span> <span class=o>=</span> <span class=n>dot</span><span class=p>(</span><span class=n>volume</span><span class=p>.</span><span class=n>mCenter</span><span class=p>,</span> <span class=n>upDirection</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 这里算出Delta是 此时高度 - 初始高度（未做moveCharacter之前的高度）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>float</span> <span class=n>Delta</span> <span class=o>=</span> <span class=n>tmp</span> <span class=o>&gt;</span> <span class=n>originalHeight</span> <span class=o>?</span> <span class=kt>float</span><span class=p>(</span><span class=n>tmp</span> <span class=o>-</span> <span class=n>originalHeight</span><span class=p>)</span> <span class=o>:</span> <span class=mf>0.0f</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>Delta</span> <span class=o>+=</span> <span class=n>fabsf</span><span class=p>(</span><span class=n>direction</span><span class=p>.</span><span class=n>dot</span><span class=p>(</span><span class=n>upDirection</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=kt>float</span> <span class=n>Recover</span> <span class=o>=</span> <span class=n>Delta</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>NbCollisions</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>float</span> <span class=n>MD</span> <span class=o>=</span> <span class=n>Recover</span> <span class=o>&lt;</span> <span class=n>min_dist</span> <span class=o>?</span> <span class=n>Recover</span><span class=o>/</span><span class=kt>float</span><span class=p>(</span><span class=n>maxIter</span><span class=p>)</span> <span class=o>:</span> <span class=n>min_dist</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PxVec3</span> <span class=nf>RecoverPoint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 向下移动
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>RecoverPoint</span> <span class=o>=</span> <span class=o>-</span><span class=n>upDirection</span><span class=o>*</span><span class=n>Recover</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=n>doSweepTest</span><span class=p>(</span><span class=n>userData</span><span class=p>,</span> <span class=n>userHitData</span><span class=p>,</span> <span class=n>userObstacles</span><span class=p>,</span> <span class=n>volume</span><span class=p>,</span> <span class=n>RecoverPoint</span><span class=p>,</span> <span class=n>SideVector</span><span class=p>,</span> <span class=n>maxIter</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>NbCollisions</span><span class=p>,</span> <span class=n>MD</span><span class=p>,</span> <span class=n>filters</span><span class=p>,</span> <span class=n>SWEEP_PASS_UP</span><span class=p>,</span> <span class=n>touchedActor</span><span class=p>,</span> <span class=n>touchedShape</span><span class=p>,</span> <span class=n>contextID</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>mFlags</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>STF_NORMALIZE_RESPONSE</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>这样就解决了这个问题</p><h2 id=physx-cct缺陷><a href=#physx-cct缺陷 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:physx-cct缺陷 class=headings>PhysX CCT缺陷</a></h2><h3 id=钻墙的缺陷><a href=#钻墙的缺陷 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:钻墙的缺陷 class=headings>钻墙的缺陷</a></h3><p>首先，最显而易见的是钻矮墙会钻不过去。由于他是先做爬坡逻辑，而爬坡会将CCT向上移动再向前，这使得CCT在钻矮墙的时候可能被<code>SIDE_PASS</code>挡住从而钻不过去。即使CCT本身的高度并没有那么高。</p><p><video src=/assets/PhysXCCT钻矮墙问题.mp4 controls></video></p><h3 id=preventclimbing带来的问题><a href=#preventclimbing带来的问题 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:preventclimbing带来的问题 class=headings>PreventClimbing带来的问题</a></h3><p>首先是<code>PreventClimbing</code>和<code>PreventClimbingAndForceSliding</code>的缺陷。</p><p><code>PreventClimbing</code>会阻止CCT爬坡。但同时他也不会让CCT落下。于是CCT会一直停在坡上。这显然是不合逻辑的：</p><p><video src=/assets/PhysXCCT卡在墙上.mp4 controls></video></p><p>这里是因为用户自己没有设置下滑的逻辑：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=n>sweepPass</span><span class=o>!=</span><span class=n>SWEEP_PASS_SENSOR</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 这里shapeHitCallback内会调用用户的CCTBehavior回调。你没设置默认返回0，stopSliding就是true，会阻止下滑
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>const</span> <span class=n>PxU32</span> <span class=n>behaviorFlags</span> <span class=o>=</span> <span class=n>shapeHitCallback</span><span class=p>(</span><span class=n>userHitData</span><span class=p>,</span> <span class=n>C</span><span class=p>,</span> <span class=n>currentDirection</span><span class=p>,</span> <span class=n>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>stopSliding</span> <span class=o>=</span> <span class=p>(</span><span class=n>behaviorFlags</span> <span class=o>&amp;</span> <span class=n>PxControllerBehaviorFlag</span><span class=o>::</span><span class=n>eCCT_SLIDE</span><span class=p>)</span><span class=o>==</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>只要设置上就可以了。</p></li></ol><p>那么设置了<code>PreventClimbingAndForceSliding</code>呢？确实会滑下来。但是在滑下来的过程中你贴着墙按水平方向的移动是无效的。他会一直下滑直到落到可以站立的地方，这时你才能左右移动。因为在代码里把水平位移去掉了：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// 在第一次moveCharacter之后，第二次moveCharacter之前
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span><span class=p>(</span><span class=n>mCctModule</span><span class=p>.</span><span class=n>mFlags</span> <span class=o>&amp;</span> <span class=n>STF_HIT_NON_WALKABLE</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// A bit slow, but everything else I tried was less convincing...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mCctModule</span><span class=p>.</span><span class=n>mFlags</span> <span class=o>|=</span> <span class=n>STF_WALK_EXPERIMENT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>volume</span><span class=p>.</span><span class=n>mCenter</span> <span class=o>=</span> <span class=n>Backup</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 这里去掉了水平位移
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>PxVec3</span> <span class=n>xpDisp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>mUserParams</span><span class=p>.</span><span class=n>mNonWalkableMode</span><span class=o>==</span><span class=n>PxControllerNonWalkableMode</span><span class=o>::</span><span class=n>ePREVENT_CLIMBING_AND_FORCE_SLIDING</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>PxVec3</span> <span class=n>tangent_compo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>decomposeVector</span><span class=p>(</span><span class=n>xpDisp</span><span class=p>,</span> <span class=n>tangent_compo</span><span class=p>,</span> <span class=n>disp</span><span class=p>,</span> <span class=n>upDirection</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=n>xpDisp</span> <span class=o>=</span> <span class=n>disp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>collisionFlags</span> <span class=o>=</span> <span class=n>mCctModule</span><span class=p>.</span><span class=n>moveCharacter</span><span class=p>(</span><span class=o>&amp;</span><span class=n>findGeomData</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>userHitData</span><span class=p>,</span> <span class=n>volume</span><span class=p>,</span> <span class=n>xpDisp</span><span class=p>,</span> <span class=n>userObstacles</span><span class=p>,</span> <span class=n>minDist</span><span class=p>,</span> <span class=n>filters</span><span class=p>,</span> <span class=n>constrainedClimbingMode</span><span class=p>,</span> <span class=n>standingOnMoving</span><span class=p>,</span> <span class=n>touchedActor</span><span class=p>,</span> <span class=n>touchedShape</span><span class=p>,</span> <span class=n>getContextId</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mCctModule</span><span class=p>.</span><span class=n>mFlags</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>STF_WALK_EXPERIMENT</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>就很离谱。只能说是PhysX的一种设计吧。</p><h3 id=爬楼梯的缺陷><a href=#爬楼梯的缺陷 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:爬楼梯的缺陷 class=headings>爬楼梯的缺陷</a></h3><p>爬楼梯的计算可能有误，在<code>DOWN_PASS</code>之后判断爬楼梯的逻辑是：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=n>constrainedClimbingMode</span> <span class=o>&amp;&amp;</span> <span class=n>PxExtended</span><span class=p>(</span><span class=n>mContactPointHeight</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>originalBottomPoint</span> <span class=o>+</span> <span class=n>PxExtended</span><span class=p>(</span><span class=n>stepOffset</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div></div><p>注意这里是<strong>用接触点的位置和stepOffset进行对比</strong>。但我们用的是胶囊体不是圆柱体，这样可能导致误差：</p><p><img src=/assets/PhysXCCT%E7%88%AC%E6%A5%BC%E6%A2%AF%E7%BC%BA%E9%99%B7.png alt=PhysXCCT爬楼梯缺陷></p><p>这在圆柱体非常宽大的时候误差会很大。</p><h2 id=sensor_pass在做什么><a href=#sensor_pass在做什么 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:sensor_pass在做什么 class=headings>SENSOR_PASS在做什么</a></h2><p>如果你指定了攀爬模式为<code>ConstraintClimbingMode</code>，PhysX会在<code>SIDE_PASS</code>未碰到物体时再做一次<code>SENSOR_PASS</code>。这是为了避免在移动距离很短的情况下，非常小物体一直阻挡着CCT移动：</p><p><img src=/assets/PhysXCCTSENSOR_PASS%E7%94%A8%E9%80%94.png alt=SENSOR_PASS用途></p><p>这里可能会判定到无法越过（如果StepOffset很小甚至为0的话）。</p><p>而这时通过<code>SENSOR_PASS</code>延长了横向的探测距离，在<code>DOWN_PASS</code>之后的爬坡检测就会通过，CCT就可以越过障碍物。</p></div></article><div class=updated-badge-container><span title="Updated @ 2025-08-02 14:43:02 UTC" style=cursor:help><svg width="130" height="20" class="updated-badge"><linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient><clipPath id="a"><rect width="130" height="20" rx="3" fill="#fff"/></clipPath><g clip-path="url(#a)"><path class="updated-badge-left" d="M0 0h55v20H0z"/><path class="updated-badge-right" d="M55 0h75v20H55z"/><path fill="url(#b)" d="M0 0h130v20H0z"/></g><g fill="#fff" text-anchor="middle" font-size="110"><text x="285" y="150" fill="#010101" fill-opacity=".3" textLength="450" transform="scale(.1)">updated</text><text x="285" y="140" textLength="450" transform="scale(.1)">updated</text><text x="915" y="150" fill="#010101" fill-opacity=".3" textLength="650" transform="scale(.1)">2025-08-02</text><text x="915" y="140" textLength="650" transform="scale(.1)">2025-08-02</text></g></svg></span></div><div class=post-share><div class=share-items><div class="share-item facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=https://visualgmq.github.io/posts/physx-cct%E8%AE%BE%E8%AE%A1%E4%B8%8E%E7%BC%BA%E9%99%B7/&amp;hashtag=%23GamePhysics" title target=_blank rel=noopener><svg viewBox="0 0 512 512" class="icon facebook-icon"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg></a></div><div class="share-item mastodon"><a href="/fedishare.html#title=PhysX%20CCT%e8%ae%be%e8%ae%a1%e4%b8%8e%e7%bc%ba%e9%99%b7&amp;description=%e6%9c%ac%e6%96%87%e5%9f%ba%e4%ba%8ePhysX5.5.0%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%ef%bc%88%e4%b8%8d%e8%bf%87PhysX%e5%9c%a8%e8%bf%99%e6%96%b9%e9%9d%a2%e4%bb%8e4.0%e5%bc%80%e5%a7%8b%e5%87%a0%e4%b9%8e%e6%b2%a1%e6%9c%89%e4%bb%80%e4%b9%88%e6%94%b9%e5%8a%a8%ef%bc%89%e3%80%82%e8%ae%b2%e8%bf%b0%e4%ba%86PhysX%20CharacterController%e7%9a%84%e8%ae%be%e8%ae%a1%e5%ae%9e%e7%8e%b0%ef%bc%8c%e4%bb%a5%e5%8f%8a%e5%85%b6%e4%b8%ad%e5%ad%98%e5%9c%a8%e7%9a%84%e9%97%ae%e9%a2%98%e3%80%82%0a%e6%b3%a8%ef%bc%9aPhysX%e7%9a%84CCT%e5%ae%9e%e7%8e%b0%e9%9d%9e%e5%b8%b8%e7%ae%80%e9%99%8b%ef%bc%88%e5%a6%82%e6%9e%9c%e4%b8%8d%e6%98%af%e5%b7%a5%e4%bd%9c%e5%8e%9f%e5%9b%a0%e4%b8%8d%e5%bb%ba%e8%ae%ae%e7%9c%8b%e6%ba%90%e7%a0%81%ef%bc%8c%e6%9c%89%e8%bf%99%e6%97%b6%e9%97%b4%e4%b8%8d%e5%a6%82%e5%8e%bb%e7%9c%8b%e7%9c%8bUE%e6%88%96%e8%80%85Jolt%e8%bf%99%e7%a7%8d%e7%89%a9%e7%90%86%e5%bc%95%e6%93%8e%e7%9a%84%e5%ae%9e%e7%8e%b0%ef%bc%89%ef%bc%8c%e8%80%8c%e4%b8%94%e5%ad%98%e5%9c%a8%e5%be%88%e5%a4%9a%e9%97%ae%e9%a2%98%e3%80%82%e6%88%91%e6%98%af%e5%9b%a0%e4%b8%ba%e5%b7%a5%e4%bd%9c%e5%8e%9f%e5%9b%a0%e6%89%8d%e8%a6%81%e5%ad%a6%e4%b9%a0%ef%bc%8c%e6%b2%a1%e5%8a%9e%e6%b3%95%e3%80%82%0a&amp;url=https://visualgmq.github.io/posts/physx-cct%E8%AE%BE%E8%AE%A1%E4%B8%8E%E7%BC%BA%E9%99%B7/" title target=_blank rel=noopener><svg viewBox="0 0 448 512" class="icon mastodon-icon"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></a></div><div class="share-item fediverse"><a href="/fedishare.html#title=PhysX%20CCT%e8%ae%be%e8%ae%a1%e4%b8%8e%e7%bc%ba%e9%99%b7&amp;description=%e6%9c%ac%e6%96%87%e5%9f%ba%e4%ba%8ePhysX5.5.0%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%ef%bc%88%e4%b8%8d%e8%bf%87PhysX%e5%9c%a8%e8%bf%99%e6%96%b9%e9%9d%a2%e4%bb%8e4.0%e5%bc%80%e5%a7%8b%e5%87%a0%e4%b9%8e%e6%b2%a1%e6%9c%89%e4%bb%80%e4%b9%88%e6%94%b9%e5%8a%a8%ef%bc%89%e3%80%82%e8%ae%b2%e8%bf%b0%e4%ba%86PhysX%20CharacterController%e7%9a%84%e8%ae%be%e8%ae%a1%e5%ae%9e%e7%8e%b0%ef%bc%8c%e4%bb%a5%e5%8f%8a%e5%85%b6%e4%b8%ad%e5%ad%98%e5%9c%a8%e7%9a%84%e9%97%ae%e9%a2%98%e3%80%82%0a%e6%b3%a8%ef%bc%9aPhysX%e7%9a%84CCT%e5%ae%9e%e7%8e%b0%e9%9d%9e%e5%b8%b8%e7%ae%80%e9%99%8b%ef%bc%88%e5%a6%82%e6%9e%9c%e4%b8%8d%e6%98%af%e5%b7%a5%e4%bd%9c%e5%8e%9f%e5%9b%a0%e4%b8%8d%e5%bb%ba%e8%ae%ae%e7%9c%8b%e6%ba%90%e7%a0%81%ef%bc%8c%e6%9c%89%e8%bf%99%e6%97%b6%e9%97%b4%e4%b8%8d%e5%a6%82%e5%8e%bb%e7%9c%8b%e7%9c%8bUE%e6%88%96%e8%80%85Jolt%e8%bf%99%e7%a7%8d%e7%89%a9%e7%90%86%e5%bc%95%e6%93%8e%e7%9a%84%e5%ae%9e%e7%8e%b0%ef%bc%89%ef%bc%8c%e8%80%8c%e4%b8%94%e5%ad%98%e5%9c%a8%e5%be%88%e5%a4%9a%e9%97%ae%e9%a2%98%e3%80%82%e6%88%91%e6%98%af%e5%9b%a0%e4%b8%ba%e5%b7%a5%e4%bd%9c%e5%8e%9f%e5%9b%a0%e6%89%8d%e8%a6%81%e5%ad%a6%e4%b9%a0%ef%bc%8c%e6%b2%a1%e5%8a%9e%e6%b3%95%e3%80%82%0a&amp;url=https://visualgmq.github.io/posts/physx-cct%E8%AE%BE%E8%AE%A1%E4%B8%8E%E7%BC%BA%E9%99%B7/" title target=_blank rel=noopener><svg viewBox="64 163 873 873" class="icon fediverse-icon"><defs><linearGradient id="fediverse-gradient"><stop offset="0" stop-color="#ff0101"/><stop offset="10%" stop-color="#9501ff"/><stop offset="50%" stop-color="#ffca01"/><stop offset="75%" stop-color="#01a3ff"/><stop offset="100%" stop-color="#65ff01"/></linearGradient></defs><path d="M539 176q-32 0-55 22t-25 55 20.5 58 56 27 58.5-20.5 27-56-20.5-59T544 176h-5zm-87 95-232 118q20 20 25 48l231-118q-19-20-24-48zm167 27q-13 25-38 38l183 184q13-25 39-38zM477 320 342 585l40 40 143-280q-28-5-48-25zm104 16q-22 11-46 10l-8-1 21 132 56 9zM155 370q-32 0-55 22.5t-25 55 20.5 58 56.5 27 59-21 26.5-56-21-58.5-55.5-27h-6zm90 68q1 9 1 18-1 19-10 35l132 21 26-50zm225 36-26 51 311 49q-1-8-1-17 1-19 10-36zm372 6q-32 1-55 23t-24.5 55 21 58 56 27 58.5-20.5 27-56.5-20.5-59-56.5-27h-6zM236 493q-13 25-39 38l210 210 51-25zm-40 38q-21 11-44 10l-9-1 40 256q21-10 45-9l8 1zm364 22 48 311q21-10 44-9l10 1-46-294zm195 23-118 60 8 56 135-68q-20-20-25-48zm26 49-119 231q28 5 48 25l119-231q-28-5-48-25zM306 654l-68 134q28 5 48 25l60-119zm262 17-281 143q19 20 24 48l265-135zM513 771l-51 25 106 107q13-25 39-38zM222 795q-32 0-55.5 22.5t-25 55 21 57.5 56 27 58.5-20.5 27-56-20.5-58.5-56.5-27h-5zm89 68q2 9 1 18-1 19-9 35l256 41q-1-9-1-18 1-18 10-35zm335 0q-32 0-55 22.5t-24.5 55 20.5 58 56 27 59-21 27-56-20.5-58.5-56.5-27h-6z"/></svg></a></div><div class="share-item twitter"><a href="https://twitter.com/share?url=https://visualgmq.github.io/posts/physx-cct%E8%AE%BE%E8%AE%A1%E4%B8%8E%E7%BC%BA%E9%99%B7/&amp;text=PhysX%20CCT%e8%ae%be%e8%ae%a1%e4%b8%8e%e7%bc%ba%e9%99%b7&amp;hashtags=GamePhysics,%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb,&amp;via=VisualGMQ" title target=_blank rel=noopener><svg viewBox="0 0 512 512" class="icon twitter-icon"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a></div></div></div><div class=related-posts><h2 class=related-title><svg viewBox="0 0 512 512" class="icon related-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm144 276c0 6.6-5.4 12-12 12h-92v92c0 6.6-5.4 12-12 12h-56c-6.6.0-12-5.4-12-12v-92h-92c-6.6.0-12-5.4-12-12v-56c0-6.6 5.4-12 12-12h92v-92c0-6.6 5.4-12 12-12h56c6.6.0 12 5.4 12 12v92h92c6.6.0 12 5.4 12 12v56z"/></svg></h2><ul class=related-list><li class=related-item><a href=/posts/%E5%9F%BA%E4%BA%8E%E7%BA%A6%E6%9D%9F%E7%9A%84%E7%89%A9%E7%90%86%E6%B1%82%E8%A7%A3/ class=related-link>基于约束的物理求解</a></li><li class=related-item><a href=/posts/entt%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9B%9B/ class=related-link>EnTT源码分析【四】：storage</a></li><li class=related-item><a href=/posts/raylib%E7%9A%84batchrendering/ class=related-link>Raylib的BatchRendering</a></li><li class=related-item><a href=/posts/entt%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%89/ class=related-link>EnTT源码分析【三】：sparse set</a></li><li class=related-item><a href=/posts/entt%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%BA%8C/ class=related-link>EnTT源码分析【二】：Entity</a></li></ul></div><div class=post-tags><a href=/tags/game-physics/ rel=tag class=post-tags-link><svg viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>Game Physics</a>
<a href=/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/ rel=tag class=post-tags-link><svg viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>源码阅读</a></div><ul class=post-nav><li class=post-nav-next><a href=/posts/%E6%A8%A1%E6%9D%BF%E5%85%83%E7%BC%96%E7%A8%8B%E5%92%8C%E5%8F%8D%E5%B0%84ponder%E4%B8%AD%E7%9A%84%E7%BB%84%E7%BB%87%E7%BB%93%E6%9E%84/ rel=next>【模板元编程和反射】：Ponder中的组织结构 ></a></li></ul><div id=utterances></div></div></main><div id=back-to-top class=back-to-top><a href=#><svg viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a></div><footer id=footer class=footer><div class=footer-inner><div class=site-info><span class=copyleft-symbol>🄯</span>&nbsp;©&nbsp;2022–2025&nbsp;<svg viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3.0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg></div><div class=powered-by>Powered by <a href=https://github.com/gohugoio/hugo target=_blank rel=noopener>Hugo</a> | Theme is <a href=https://github.com/reuixiy/hugo-theme-meme target=_blank rel=noopener>MemE</a></div><div class=site-copyright><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a></div><ul class=socials><li class=socials-item><a href=/rss.xml target=_blank rel="external noopener" title=RSS><svg viewBox="0 0 24 24" class="icon social-icon"><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg></a></li><li class=socials-item><a href=2142587070@qq.com target=_blank rel="external noopener" title=Email><svg viewBox="0 0 512 512" class="icon social-icon"><path d="M464 64H48C21.49 64 0 85.49.0 112v288c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 4e2V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V4e2H48z"/></svg></a></li><li class=socials-item><a href=https://github.com/VisualGMQ target=_blank rel="external noopener" title=GitHub><svg viewBox="0 0 24 24" class="icon social-icon"><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a></li></ul></div></footer></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css><script>if(typeof renderMathInElement=="undefined"){const e=e=>{const t=document.createElement("script");t.defer=!0,t.crossOrigin="anonymous",Object.keys(e).forEach(n=>{t[n]=e[n]}),document.body.appendChild(t)};e({src:"https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js",onload:()=>{e({src:"https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/mhchem.min.js",onload:()=>{e({src:"https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js",onload:()=>{renderKaTex()}})}})}})}else renderKaTex();function renderKaTex(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]})}</script><script>typeof MathJax=="undefined"?(window.MathJax={loader:{load:["[tex]/mhchem"]},tex:{inlineMath:{"[+]":[["$","$"]]},tags:"ams",packages:{"[+]":["mhchem"]}}},function(){const e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js",e.defer=!0,document.head.appendChild(e)}()):(MathJax.texReset(),MathJax.typeset())</script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.3/dist/mermaid.min.js></script><script>Array.from(document.getElementsByClassName("language-mermaid")).forEach(e=>{e.parentElement.outerHTML=`<div class="mermaid">${e.innerText}</div>`});const mermaidConfig={startOnLoad:!0,flowchart:{useMaxWidth:!1,htmlLabels:!0},theme:"dark"};mermaid.initialize(mermaidConfig)</script><script>function loadComments(){(function(){const t=document.getElementById("utterances");if(!t)return;const e=document.createElement("script");e.src="https://utteranc.es/client.js",e.async=!0,e.crossOrigin="anonymous",e.setAttribute("repo","VisualGMQ/myblog-utterances-comment"),e.setAttribute("issue-term","pathname");const n=getCurrentTheme()==="dark";n?e.setAttribute("theme","gruvbox-dark"):e.setAttribute("theme","gruvbox-dark"),e.setAttribute("label","评论"),t.appendChild(e)})()}</script><script src=https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js></script><script>let imgNodes=document.querySelectorAll("div.post-body img");imgNodes=Array.from(imgNodes).filter(e=>e.parentNode.tagName!=="A"),mediumZoom(imgNodes,{background:"hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)"})</script><script src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js type=module defer></script><script async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>