# Grogue游戏开发日志

![Grogue Github](https://github-readme-stats.vercel.app/api/pin/?username=VisualGMQ&repo=grogue)

## 2023.1.5

已经2023年了，Grogue的开发依然处于初级阶段。在过去的一年中，通过反复编写Grogue，现在终于确定了Grogue的核心玩法和游戏表现类型。最新的Grogue仍然使用SDL&C++进行开发，从原先的TRoguelike变为了Roguelite：

这是目前的成果：

* 玩家走路，现在有碰撞检测
    ![walk](/img/grogue/walk.gif)
* 拾取物品和背包系统
    ![backpack](/img/grogue/backpack.gif)
    ![pickup](/img/grogue/pickup)
* 合成物品和放置物品
    ![compose and put](/img/grogue/compose_and_put.gif)

可以看到比起之前所做的，无论是画面还是游戏功能都有不少的长进。尽管Grogue的游戏形式和内容发生了变化，但制作此游戏的目标依然没有改变：

* 制作**我认为最好玩的Roguelite**
* 从Grogue的制作中提炼出自己的游戏引擎
* 证明抛开渲染，只使用SDL也可以做出很好玩的游戏

最近，也许是下一周，也许是年后（15号之后），Grogue的底层会被彻底换成基于ECS的系统。现在ECS部分已经做的差不多了，但是还没有迁移到Grogue中。

另一个困扰我很长时间的问题是物理引擎（或者说碰撞检测与碰撞分离），但幸运的是我已经有一套学习路线了，所以Grogue的开发应该还会延后，直到我完成物理引擎方面的学习。

## 2022.3.28

增加了背包栏的UI，玩家现在可以吃食物回复饱食度和生命值，并且可以从浆果丛中采摘浆果。

![简单原型2](/img/grouge/简单原型2.png)

## 2022.3.25

现在在使用Python编写简单的原型，以确定我的游戏到底要发展成什么样：

![简单原型](/img/grogue/grogue-python-proto.png)

用Python真就无脑写呗，完全不需要考虑设计，反正用完也就丢了😁。就是动态类型搞得有点头疼，经常因为类型不一致产生bug。

## 2022.3.18

删除了所有的代码，从头开始。

这半年时间内我主要在做我自己的SDLEngine游戏引擎，在里面学到了不少东西，包括GUI系统，音频系统等。回看我这个游戏的代码，确实写的不是很行，所以我打算全部推翻重做。

这一次我不打算使用ECS，而是使用传统的`Sprite`方法编写。ECS虽然很好用，增加删除的灵活性很高，但是如果没有一个ECS的编辑器（像其他次时代游戏引擎一样），越写就越混乱，各个Entity和Component的组合令人头晕眼花。

这次和往常一样，只使用SDL制作，也不使用任何和SDL相关的游戏引擎（比如我的SDLEngine），因为我打算从零开始写出一个完整的游戏，然后从中抽象出我自己的游戏引擎（为以后SDLEngine的升级做准备）。

我之前太过于沉溺于制作游戏引擎，而忽略了一件非常重要的事情：游戏引擎其实是从游戏本体中抽出的可复用的基础代码。像市面上的游戏引擎（如UE4，Unity等）都是*通用游戏引擎*，他们可以制作各种各样的游戏，但他们通常都非常庞大，并且在某一游戏开发方向不够*精*。我如果想要制作自己的游戏引擎，我必须先制作自己的游戏，然后从游戏中找寻到引擎的原型。

所以Grogue开发其实是要做两件事情：

1. 开发出我心目中最好玩的TRoguelike
2. 从Grogue中寻找我以后游戏引擎的发展方向

我还需要对Grogue进行充分的设计，确定其基本的游戏内容，画面的表现形式等，等这一切都有了大致的方向之后，我才能开始编写游戏代码。

## 2021.8.22

<video src="/img/grogue/2021-08-22.mov" width="100%" height="100%" controls="controls">
</video>

这几天写了个小的REGUI，重整了一下UI界面。  
武器本来已经加上去了，但是武器是直接加在怪物身上的。我想做到怪物有多少只手就可以拿多少武器，所以又写了手的部分，暂时没有改老的武器部分的代码（懒）

* 使用`a`键来使用物品
* 加入了时间系统，现在所有的动作都会有不同的行动值
* 拾取和丢弃操作现在会出现菜单让玩家选择物品

## 2021.8.8

这几天把东西全部重构了，加入了Lua，把所有的配置信息全部移动到Lua里面去了。然后改善了代码结构。

## 2021.7.23

<video src="/img/grogue/2021-07-23.mov" width="100%" height="100%" controls="controls">
</video>

道具什么的加上去了，现在主要加了药水和卷轴。  
按下`e`键可以使用物品，我暂时不打算像Nethack那样将阅读卷轴和喝药水的指令分开。  
下方的日志系统补完了。  
后面打算把武器和防具整上去。  

## 2021.7.18

<video src="/img/grogue/2021-07-18.mov" width="100%" height="100%" controls="controls">
</video>

这几天学了Nim，本来是打算用Nim重写的，但是试了几天发现不行，Nim有些地方我不知道怎么处理，所以用C++重写了。  
这里已经基本赶上之前的进度了，怪物可以移动和攻击。目前物品什么的还没做。  
地牢现在可以随机生成，不过目前只有一种洞穴生成算法。  
找到了一个RogueLike开发网站[RogueBasin](http://roguebasin.roguelikedevelopment.org/)，上面资料很全，在上面学到了不少东西。

## 2021.6.23

<video src="/img/grogue/2021-06-23.mov" width="100%" height="100%" controls="controls">
</video>

增加了上下楼梯的功能。  
不过现在楼梯之间没有关联，即下楼楼梯不能指定与之相通的上楼楼梯在什么地方。我打算先维持这个样子，下一步是让怪物动起来。

## 2021.6.22

<video src="/img/grogue/2021-06-22.mov" width="100%" height="100%" controls="controls">
</video>

这次摸索出了UI界面的制作，用上了之前撘底层时写的ImGUI。  
主要增加了：

* 按下`i`键打开背包
* 按下`g`键拾取地上的物品
* 按下`q`键喝药水

卷轴和武器什么的我暂时不打算做。我后面打算把上楼下楼的功能做了，然后引入游戏时间，让怪物也可以动起来。毕竟框架已经搭好了，加卷轴和其他道具是很简单的事情。


## 2021.6.18
<video src="/img/grogue/2021-06-18.mov" width="100%" height="100%" controls="controls">
</video>

这次使用了SDL作为底层，终于有了还不错的画面。  
主要增加了：  

* 地图的保存和加载
* 人物的移动
* 人物的攻击
* 人物属性面板的绘制
* 日志系统及绘制

现在我有一个难点，就是我需要能够展示背包里面的东西，这样我才能继续做武器，装备等道具。我需要在用户按下`i`键的时候打开背包面板，展示背包里的东西。这一部分可能需要花一段时间，因为我需要考虑这部分如何实现。

## 2021.6.9

![Grogue GUI part](/img/grogue/2021-06-09.png)

所有代码推翻重写了，底层改用SDL。主要是之前代码写的实在不咋地。  
通过毕业设计我学到了不少知识，其中包括一些游戏代码的设计和架构，所以我飘了，觉得我可以用SDL🤣。  
目前实现了如下功能：  

* 一个稳定的底层，也可以视为一个小型游戏引擎，封装了SDL的方方面面。主要有：
    * 一个易拓展的渲染器，可以很轻松地将底层从SDL换成其他的（比如OpenGL）
    * 一个摄像机系统。
    * 一个ImGui系统（目前还在开发新的Widget）。
    * 一个音频系统，可以播放音频。
    * 专门用于本游戏的TiledSheet解析器。
    * 层，类似于PhotoShop的图层。
* 一点点游戏代码
* 使用`ChaiScript`作为脚本语言

以前的代码弊端就在于不稳定，所谓不稳定就是指编写的一些代码容易产生运行时错误，像是段错或者找不到资源等。但是这次我的底层引擎很稳定，代码怎么写都几乎不会崩。  
这次用了智能指针和空对象模式，提高了不少稳定性。  
然后使用`ChaiScrip`作为脚本语言，因为它和C++交互比较简单（比Lua还简单），我目前就暂定只用这个脚本语言了，因为我不是很想花时间在和脚本的通信上。  
游戏主体部分我在考虑要不要用ECS，主要是我对ECS不熟悉，平时也没用过。  
这次我为每个模块都写了详细的单元测试，直接学习一波敏捷开发，时不时用一下TDD，测试即文档。我发现要想写单元测试，就得把模块之间解耦，所以这也促进了我代码的结构。  
总感觉这个游戏比一开始更有希望完成了😁。  


## 2021.5.4

这几天学习了一些ECS架构，然后把所有的代码全部重写成了ECS架构。  
学习了一些Angband代码，学了一些游戏引擎方面的设计，把这些设计用在这游戏上。  

后面要二战了，可能每天更新的不多，但是我还是尽量每天抽出一小时来更新。

## 2021.4.25

这几周许多笔试和面试比较忙，没什么时间更新，而且之前的代码写的很混乱，在重构。  

* 重构了所有代码，为以后加入Lua脚本预留了接口
* 加入了json库用来保存地图，在尝试将地图保存下来

## 2021.4.5

<video src="/img/grogue/2021-04-05.mov" width="100%" height="100%" controls="controls">
</video>

* 加入了记忆，让怪物可以记住已经看到过的地形，相对的，没有看到过的地形不会被绘制出来。
* 怪物现在站在地面上了（代码方面）
* 增加了观察模式，按下`;`就可以进入观察模式。观察模式下游戏的回合数不会发生改变，玩家可以观察地图，按下`esc`即可回到游戏模式


## 2021.4.3

<video src="/img/grogue/2021-04-03.mov" width="100%" height="100%" controls="controls">
</video>

*   加入了视野：让怪物拥有视野，只有在视野范围内的东西会清晰地显示在地图上。视野之外的东西的活动不会显示在地图上。后面还会加入记忆系统让怪物记住地图。
*   调整了墙体的颜色。

## 2021.4.2

![能力面板，地板](/img/grogue/2021-04-02.png)

最近比较忙，更新的幅度比较小。

*   增加了能力面板：在最上方，会显示玩家的姓名，各项能力值和等级，后面有背包系统了还会加上金钱和其他什么的。

*   增加了地板：地图中的小点点就是地板，其实墙和门也是放在地板上的。后面有道具系统的话道具也会被放置在地板上。现在只有怪物不是在地板上（从代码方面来说），这里怪物要怎么处理还未定

## 2021.3.30  玩家，房间，碰撞和Daily

<video src="/img/grogue/2021-03-30.mov" width="100%" height="100%" controls="controls">
</video>

<center>视频演示</center>

今天实现了墙壁，门和简单的玩家。还有Daily系统（游戏日志）。

人物的移动我采用的典型的vim式移动：

```
y k u
 \|/
h-.-l
 /|\
b j n
```

提供8方向的移动，按下`.`（英文句号）可以等待一回合。

墙壁的话是不可以穿过去的。

门的话可以打开，但是不能“斜角开门”，即在对角线方向开门，只能站在门的正前方，向门走动的话才可以开门。

按下`c`键可以关闭附近的门，同理也不能“斜角关门”。

Daily系统就是记录下游戏中发生的各个事件的记录器，显示在最下面。每次有新事件发生时会显示并且暂停游戏，玩家需要按下任意键继续游戏。

我还对终端的大小进行了一些限制，游戏在默认终端大小（80x25）下进行，如果你的终端过小，游戏将显示错误信息并且退出。

## 2021.3.29 Grogue的大体设计

今天我才发现我还没有确定的我游戏的目标🤣，这里我就简单说一下我对游戏的大体期望。

我的游戏不是在地牢中进行的，而是在“塔”中进行的，其实都差不多啦，只不过是向上爬塔而已。

游戏的设定是在一个剑与魔法的世界，背景是“这座古老的塔中突然出现了异次元之门，这个门内出现了很多的怪物，我们的主角跟着部队去关闭次元之门，以防怪物侵略这个世界（DOOM既视感）”。

注意玩家只是**部队中的一员**而不是部队的队长之类的，他只是个普通的人，所以一开始他并不会有什么很高的数值。

而且部队一进塔就被乱杀🤣，导致主角和其他人走散了，所以开局时只有你一个人。

游戏的目标很简单：到达塔顶关闭门之后再回到塔底即获胜（就是需要生还），不过我不希望玩家返程时总是一层一层地回到第一层，我会给一些可以提供“捷径”的道具或其他什么的。

## 2021.3.28 日志系统的开发

<video src="/img/grogue/2021-03-28 -log.mov" width="100%" height="100%" controls="controls">
</video>

<center>效果如上面的视频</center>

在游戏的正式开发开始之前，我希望我的程序可以有一些调试功能。因为我的程序一旦打开就会进入ncurses模式，这样我不能够使用任何的对终端的IO流来输出错误信息了。我当然可以将错误写入文件中，不过我更希望实时地查询到产生的错误信息，所以我这里先做了个小的日志系统。

这个日志系统会有一个日志面板，通过特定的按键可以打开和关闭（视频中是'T'）。有三种日志函数`Logw`,`Logd`,`Loge`,`Logt`分别用于WARN，DEBUG，ERROR和TRACE等级的日志。不同等级的日志所展示的颜色是不一样的，WARN是黄色，ERROR是红色，DEBUG是蓝色而TRACE是白色。

我还为我的日志系统增加了小的过滤器，通过特定的按键可以只显示某些特定等级的日志信息。我还为日志面板增加了滚动的功能，通过`j`键可以向上滚动，而`k`键可以向下滚动，这样方便我查看更多的信息。

## 2021.3.25 Grogue开发开始啦✌️

![nethack](https://i.loli.net/2021/03/25/1LDG45HwbnkIW7O.jpg)

我一直是一个Roguelike，尤其是TRoguelike游戏的爱好者。在不停地尝试新Roguelike的时候，我总有一种自己制作Roguelike的冲动。这次我觉得应该将这种冲动付诸现实了。

Grogue是一款TRoguelike类型的游戏，和传统Roguelike一样，我希望这款游戏可以无限逼近**我心中最理想的TRoguelike游戏**，开始吧！
